# üéôÔ∏è Natural Language Smart Contracts - Voice-to-Vault Setup Guide

## üîÑ Recent Updates (Nov 2, 2025)

‚úÖ **System Prompt Enhanced** - Added CRITICAL section with explicit function-calling instructions and examples
‚úÖ **Function Descriptions Improved** - Now more explicit about parameter requirements with concrete examples
‚úÖ **Production URLs Updated** - All function URLs now point to Heroku production (`https://syft-f6ad696f49ee.herokuapp.com`)
‚úÖ **Frontend Backend URL Fixed** - Frontend now connects to production backend
‚úÖ **Better Error Handling** - Added detailed logging for Zod validation errors
‚úÖ **Prompt Parameter Validation** - Client-side validation ensures prompt is never undefined

## Overview

This implementation adds **Voice-to-Vault** capabilities to Syft, allowing users to create DeFi vault strategies using natural voice commands powered by VAPI (Voice AI Platform).

## Features Implemented

### ‚úÖ 1. Voice-to-Vault
- Real-time voice interaction with AI assistant
- Natural conversation flow for vault creation
- Voice waveform visualization
- Multi-turn conversations for strategy refinement

### ‚úÖ 2. Conversational Refinement
- Modify existing vaults through voice commands
- "Increase USDC allocation to 80%"
- "Add staking to Aqua protocol"
- "Make it more conservative"

### ‚úÖ 3. Strategy Templates from Prompts
- Pre-built templates (conservative, balanced, aggressive)
- Template suggestions based on user preferences
- One-command vault creation: "Create a conservative stablecoin strategy"

### ‚úÖ 4. Contract Explanation
- AI explains deployed contracts in plain English
- No technical jargon
- Uses analogies and simple language
- Available through voice or text

### ‚úÖ 5. Visual + NL Hybrid
- Three builder modes: Visual, AI Chat, Voice
- Seamless switching between modes
- Real-time preview of voice-generated vaults
- Visual validation feedback

---

## üöÄ Setup Instructions

### Step 1: Install Dependencies

The VAPI SDK has already been installed in the frontend:

```bash
cd frontend
npm install @vapi-ai/web
```

### Step 2: Configure Environment Variables

Your `.env.local` already has the VAPI credentials:

```env
VITE_PUBLIC_VAPI_PUBLIC_KEY=ae7d6d88-88cf-4800-9863-77badd2ff560
VITE_PUBLIC_ASSISTANT_ID=f3695e73-ff32-446e-9e79-a427e5b9656c
```

For the backend, add OpenAI API key to `.env`:

```env
OPENAI_API_KEY=your_openai_api_key_here
```

### Step 3: Setup VAPI Assistant on Dashboard

‚ö†Ô∏è **IMPORTANT**: Let the AI assistant decide when to call functions naturally. Don't force it to call functions on every interaction.
The tool descriptions should be informative but not coercive. The AI is smart enough to know when to call a function.

1. **Go to VAPI Dashboard**: https://dashboard.vapi.ai/
2. **Login** with your credentials
3. **Create New Assistant** or update existing one (ID: f3695e73-ff32-446e-9e79-a427e5b9656c)

4. **Upload Assistant Configuration**:
   - Use the file: `vapi-assistant-config.json` (root of project)
   - Or manually configure using the settings below

#### Assistant Configuration Details:

**Basic Settings:**
- **Name**: Syft Vault Builder Assistant
- **First Message**: "Hi! I'm your Syft vault building assistant. I'm here to help you create an automated investment strategy on Stellar. Would you like to start with a template, or should we build a custom strategy from scratch?"

**Transcriber Settings:**
- **Provider**: Deepgram
- **Model**: nova-2
- **Language**: English (en)

**Model Settings:**
- **Provider**: OpenAI
- **Model**: gpt-5-nano-2025-08-07
- **Temperature**: 0.7
- **Max Tokens**: 1000

**System Prompt**:
```
You are an expert DeFi strategist and assistant for Syft, a platform for creating automated vault strategies on Stellar blockchain.

Your role:
1. Help users create vault strategies through natural conversation
2. Understand user's risk tolerance, investment goals, and strategy preferences
3. Call the appropriate functions to generate, modify, or explain vault configurations
4. Ask clarifying questions when needed
5. Explain DeFi concepts in simple, accessible language
6. Guide users through the vault creation process step-by-step

Vault Strategy Elements:
- Risk Levels: Low (conservative, stablecoins), Medium (balanced), High (aggressive yield farming)
- Actions: Deposit, Stake, Swap, Harvest, Rebalance, Withdraw
- Protocols: Soroswap, Blend Protocol, Aqua, etc.
- Assets: USDC, XLM, and other Stellar tokens

Conversation Guidelines:
- Be friendly, clear, and concise
- Ask one question at a time
- Confirm important decisions before executing
- Explain risks and expected yields
- Use analogies to simplify complex concepts

When to call generate_vault_strategy:
- User clearly wants to CREATE or BUILD a vault strategy
- User describes WHAT they want in their vault
- You have a clear understanding of their requirements

When NOT to call it:
- User is just asking questions or exploring options
- Speech is unclear or garbled
- User is just greeting or making small talk

Function Calling Examples:
‚úÖ User: 'Create a conservative stablecoin vault' ‚Üí Call the function
‚úÖ User: 'Build me a high yield farming strategy with USDC' ‚Üí Call the function  
‚úÖ User: 'I want a balanced portfolio' ‚Üí Call the function
‚ùå User: 'Help me, uh, medium brisk' ‚Üí DON'T call (unclear speech)
‚ùå User: 'What can you do?' ‚Üí DON'T call (just asking)
‚ùå User: 'Tell me about vaults' ‚Üí DON'T call (exploratory question)

Let the AI naturally decide when to call the function. Don't force every interaction to call it.
```

**Voice Settings:**
- **Provider**: 11Labs
- **Voice**: sarah (or choose another voice)
- **Stability**: 0.5
- **Similarity Boost**: 0.75
- **Speed**: 1.0

**Advanced Settings:**
- **Silence Timeout**: 30 seconds
- **Max Duration**: 600 seconds (10 minutes)
- **Background Denoising**: Enabled
- **Recording**: Disabled (for privacy)

### Step 4: Configure Function Calling

Add these 5 functions in the VAPI dashboard under "Functions" section:

#### Function 1: `generate_vault_strategy`

**Description**: Generate a new vault strategy based on the user's description. Call this function when the user clearly expresses they want to create or build a vault. The user should explicitly describe what kind of vault they want.

**Parameters Schema**:
```json
{
  "type": "object",
  "properties": {
    "prompt": {
      "type": "string",
      "description": "The user's vault description. What they want to create. Example: 'Create a conservative stablecoin vault with 70% USDC staking and 30% in liquidity pools'"
    },
    "riskLevel": {
      "type": "string",
      "enum": ["low", "medium", "high"],
      "description": "Risk level if mentioned by user: low (conservative/safe), medium (balanced), high (aggressive/risky)"
    },
    "strategyType": {
      "type": "string",
      "description": "Type of strategy if clear from context: 'stablecoin staking', 'yield farming', 'liquidity provision', 'balanced portfolio', etc."
    }
  },
  "required": ["prompt"]
}
```

**Server URL**: `https://syft-f6ad696f49ee.herokuapp.com/api/nl/generate-vault`
**Method**: POST

---

#### Function 2: `modify_vault_strategy`

**Description**: Modify an existing vault strategy based on user feedback.

**Parameters Schema**:
```json
{
  "type": "object",
  "properties": {
    "modifications": {
      "type": "object",
      "properties": {
        "action": {
          "type": "string",
          "enum": ["add_block", "remove_block", "update_block", "adjust_allocation"]
        },
        "details": {
          "type": "string",
          "description": "What to modify"
        },
        "blockId": {
          "type": "string",
          "description": "Block ID to modify (optional)"
        },
        "newValues": {
          "type": "object"
        }
      },
      "required": ["action", "details"]
    }
  },
  "required": ["modifications"]
}
```

**Server URL**: Not needed (handled client-side)

---

#### Function 3: `explain_contract`

**Description**: Explain what a vault strategy does in plain English.

**Parameters Schema**:
```json
{
  "type": "object",
  "properties": {
    "vaultConfig": {
      "type": "object",
      "description": "Vault configuration to explain"
    },
    "vaultId": {
      "type": "string",
      "description": "Vault ID if deployed"
    }
  }
}
```

**Server URL**: `https://syft-f6ad696f49ee.herokuapp.com/api/nl/explain-contract`
**Method**: POST

---

#### Function 4: `get_vault_templates`

**Description**: Get pre-built vault strategy templates.

**Parameters Schema**:
```json
{
  "type": "object",
  "properties": {
    "category": {
      "type": "string",
      "enum": ["all", "low-risk", "medium-risk", "high-risk"]
    }
  }
}
```

**Server URL**: `https://syft-f6ad696f49ee.herokuapp.com/api/nl/vault-templates`
**Method**: GET

---

#### Function 5: `analyze_strategy`

**Description**: Analyze a vault strategy for risks and optimizations.

**Parameters Schema**:
```json
{
  "type": "object",
  "properties": {
    "nodes": {
      "type": "array",
      "description": "Vault blocks"
    },
    "edges": {
      "type": "array",
      "description": "Block connections"
    }
  },
  "required": ["nodes", "edges"]
}
```

**Server URL**: `https://syft-f6ad696f49ee.herokuapp.com/api/nl/analyze-strategy`
**Method**: POST

---

### Step 5: Start the Services

1. **Start Backend** (Terminal 1):
```bash
cd backend
npm run dev
```

2. **Start Frontend** (Terminal 2):
```bash
cd frontend
npm run dev
```

3. **Verify APIs are working**:
```bash
# Test health endpoint
curl http://localhost:3001/api/health

# Test NL endpoint
curl http://localhost:3001/api/nl/vault-templates
```

---

## üéØ How to Use

### Using Voice Mode:

1. **Navigate to Vault Builder**: http://localhost:5173/vault-builder
2. **Switch to Voice Mode**: Click the "Voice" tab (microphone icon)
3. **Start Voice Call**: Click "Start Voice Call" button
4. **Speak Naturally**: Try these commands:
   - "Create a conservative stablecoin strategy with 70% USDC staking"
   - "Build a high-yield farming vault"
   - "Make a balanced portfolio with multiple protocols"
   - "Explain what this vault does"
   - "Increase the allocation to 80%"
   - "Add liquidity provision to Soroswap"

### Voice Commands Examples:

#### Creating Vaults:
- ‚úÖ "Create a low-risk vault that stakes USDC"
- ‚úÖ "I want a balanced strategy with 50% staking and 50% liquidity"
- ‚úÖ "Build an aggressive yield farming strategy"
- ‚úÖ "Make me a vault for passive income with stablecoins"

#### Modifying Vaults:
- ‚úÖ "Increase USDC allocation to 80%"
- ‚úÖ "Add staking to Blend Protocol"
- ‚úÖ "Remove the swap action"
- ‚úÖ "Make it more conservative"

#### Getting Information:
- ‚úÖ "What does this vault do?"
- ‚úÖ "Explain the risks"
- ‚úÖ "Show me some templates"
- ‚úÖ "What's the expected return?"

#### Refining Strategies:
- ‚úÖ "Can you make it safer?"
- ‚úÖ "I want higher yields"
- ‚úÖ "Balance it between risk and reward"
- ‚úÖ "Optimize for gas efficiency"

---

## üèóÔ∏è Architecture

### Frontend Components:

1. **`VoiceToVault.tsx`** - Main voice UI component
   - Voice call controls
   - Waveform visualization
   - Conversation transcript
   - Real-time feedback

2. **`vapiService.ts`** - VAPI integration service
   - Manages voice calls
   - Handles events and messages
   - Function call routing

3. **`useVoiceAssistant.ts`** - React hook
   - State management
   - Event handling
   - Callback registration

### Backend Endpoints:

1. **`POST /api/nl/generate-vault`** - Generate vault from NL
2. **`POST /api/nl/explain-contract`** - Explain contracts
3. **`POST /api/nl/analyze-strategy`** - Analyze strategies
4. **`GET /api/nl/vault-templates`** - Get templates

---

## üîß Troubleshooting

### Voice Not Working:

1. **Check Browser Permissions**: Allow microphone access
2. **Verify VAPI Keys**: Ensure keys are in `.env.local`
3. **Check Console**: Look for VAPI initialization messages
4. **Test Microphone**: Try on another website first

### Assistant Not Responding:

1. **Check VAPI Dashboard**: Verify assistant is active
2. **Review Function URLs**: Ensure backend URLs are correct
3. **Check Logs**: Look at both frontend and backend console
4. **Verify OpenAI Key**: Make sure it's valid and has credits

### Functions Not Being Called:

1. **Check Function Definitions**: Verify schemas in VAPI dashboard
2. **Review System Prompt**: Ensure it instructs to use functions
3. **Test Backend Endpoints**: Use curl or Postman
4. **Check CORS**: Ensure backend allows VAPI requests

---

## üìä Testing Checklist

- [ ] Voice call starts successfully
- [ ] Microphone permissions granted
- [ ] Voice waveform animates
- [ ] Assistant responds to voice
- [ ] Can create vault from voice command
- [ ] Vault appears in visual preview
- [ ] Can modify vault with voice
- [ ] Contract explanation works
- [ ] Templates load correctly
- [ ] Strategy analysis works
- [ ] Can switch between modes seamlessly
- [ ] Mute/unmute works
- [ ] Call ends gracefully
- [ ] Conversation history persists

---

## üé® Customization

### Change Voice:

Edit `vapi-assistant-config.json`:
```json
"voice": {
  "provider": "11labs",
  "voiceId": "rachel",  // Change this
  "stability": 0.5,
  "similarityBoost": 0.75
}
```

Available voices: sarah, rachel, michael, bill, laura, etc.

### Adjust AI Behavior:

Modify system prompt in VAPI dashboard or `vapi-assistant-config.json`:
- Make it more/less verbose
- Change personality (formal, casual, technical)
- Add domain-specific knowledge
- Adjust risk tolerance recommendations

### Add New Functions:

1. Create backend endpoint in `naturalLanguage.ts`
2. Add function schema to VAPI dashboard
3. Update system prompt to mention new capability
4. Add handler in `useVoiceAssistant.ts`

---

## üöÄ Production Deployment

### Before Going Live:

1. **Update Server URLs**: Change localhost to production URLs in VAPI functions
2. **Add Rate Limiting**: Protect backend endpoints
3. **Enable Analytics**: Track voice interactions
4. **Add Error Tracking**: Monitor function call failures
5. **Set Up Monitoring**: Watch for API quota issues
6. **Test Thoroughly**: Run through all voice scenarios
7. **Privacy Policy**: Update with voice data handling

### Environment Variables for Production:

```env
# Frontend (.env.production)
VITE_PUBLIC_VAPI_PUBLIC_KEY=your_production_key
VITE_PUBLIC_ASSISTANT_ID=your_production_assistant_id
VITE_PUBLIC_BACKEND_URL=https://api.syft.com

# Backend (.env.production)
OPENAI_API_KEY=your_production_openai_key
ALLOWED_ORIGINS=https://syft.com,https://www.syft.com
```

---

## üéì Advanced Features (Future Enhancements)

### 1. Multi-Language Support
- Detect user language
- Switch assistant language dynamically
- Translate function responses

### 2. Voice Biometrics
- User authentication via voice
- Personalized recommendations based on voice history

### 3. Advanced Analytics
- Track successful vault creations
- Analyze common voice patterns
- Optimize system prompts based on data

### 4. Voice-Activated Trading
- "Execute a swap for $1000 USDC to XLM"
- Voice confirmation for transactions
- Emergency stop commands

### 5. Collaborative Voice Sessions
- Multiple users in same voice call
- Team strategy planning
- Real-time vault co-creation

---

## üìù Notes

- Voice calls are **not recorded** by default (privacy-first)
- Assistant can handle **up to 10 minutes** per call
- **30-second silence** timeout to save costs
- All voice processing happens **server-side** (no audio stored locally)
- Function calls are **asynchronous** - UI updates immediately
- Conversation history is **client-side only** (not persisted to DB)

---

## ü§ù Support

If you encounter issues:

1. Check console logs (both frontend and backend)
2. Review VAPI dashboard logs
3. Test individual API endpoints
4. Verify all environment variables
5. Check network tab in browser DevTools

---

## üéâ Success!

You now have a fully functional Voice-to-Vault system! Users can create sophisticated DeFi strategies just by talking naturally to your app.

**Innovation Level**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê VERY HIGH

This feature truly pushes the boundaries of DeFi accessibility and showcases cutting-edge AI integration.
